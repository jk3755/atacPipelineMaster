load("C:/Users/jsk33/Desktop/H508A-WT-02.ODC1.rawFootprintData.Rdata")
View(footprintData)
View(footprintData)
## To avoid errors, clear the list of any empty sub-lists first
footprintData <- list.clean(footprintData, function(footprintData) length(footprintData) == 0L, TRUE)
suppressMessages(library(BiocGenerics))
suppressMessages(library(GenomicRanges))
suppressMessages(library(GenomicAlignments))
suppressMessages(library(stats4))
suppressMessages(library(Rsamtools))
suppressMessages(library(genomation))
suppressMessages(library(seqLogo))
suppressMessages(library(ChIPpeakAnno))
suppressMessages(library(rlist))
## To avoid errors, clear the list of any empty sub-lists first
footprintData <- list.clean(footprintData, function(footprintData) length(footprintData) == 0L, TRUE)
geneName <- "TEST"
peaksPath <- "C:\\Users\\jsk33\\Desktop\\bug\\H508A-WT-02-merged_global_normalization_peaks.narrowPeak"
## Initialize a list to store the parsed data
parsedFootprintData <- list()
##
motifIdx <- 1
## Performing parsing operations
numMotif <- length(footprintData)
motifNames <- names(footprintData)
cat("Parsing footprint data for gene", geneName, "with", numMotif, "unique motifs", "\n")
scope <- paste0("chr", c(1:22, "X", "Y"))
grPeaks <- readBed(peaksPath, track.line = FALSE, remove.unusual = FALSE, zero.based = TRUE)
grPeaks <- keepStandardChromosomes(grPeaks, pruning.mode="coarse")
grPeaks <- keepSeqlevels(grPeaks, scope, pruning.mode="coarse")
grPeaks <- trim(grPeaks, use.names = TRUE)
############################################################
## Load the temporary data
com <- paste0("tempData <- footprintData$", motifNames[a])
eval(parse(text = com))
##
librarySize <- tempData[["librarySize"]]
coverageSize <- tempData[["coverageSize"]]
libraryFactor <- tempData[["libraryFactor"]]
PWM <- tempData[["PWM"]]
genomeSites <- tempData[["genomeSites"]]
numGenomeSites <- tempData[["numGenomeSites"]]
motifWidth <- tempData[["motifWidth"]]
extendedSites <- tempData[["extendedSites"]]
insertionMatrix <- tempData[["insertionMatrix"]]
############################################################
motifNames <- names(footprintData)
############################################################
## Load the temporary data
com <- paste0("tempData <- footprintData$", motifNames[a])
eval(parse(text = com))
##
librarySize <- tempData[["librarySize"]]
coverageSize <- tempData[["coverageSize"]]
libraryFactor <- tempData[["libraryFactor"]]
PWM <- tempData[["PWM"]]
genomeSites <- tempData[["genomeSites"]]
numGenomeSites <- tempData[["numGenomeSites"]]
motifWidth <- tempData[["motifWidth"]]
extendedSites <- tempData[["extendedSites"]]
insertionMatrix <- tempData[["insertionMatrix"]]
############################################################
tempData <- list()
com <- paste0("tempData <- footprintData$", motifNames[a])
eval(parse(text = com))
##
librarySize <- tempData[["librarySize"]]
coverageSize <- tempData[["coverageSize"]]
libraryFactor <- tempData[["libraryFactor"]]
PWM <- tempData[["PWM"]]
genomeSites <- tempData[["genomeSites"]]
numGenomeSites <- tempData[["numGenomeSites"]]
motifWidth <- tempData[["motifWidth"]]
extendedSites <- tempData[["extendedSites"]]
insertionMatrix <- tempData[["insertionMatrix"]]
## Calculate total signal for each site
siteTotalSignal <- c()
for (b in 1:numGenomeSites){
siteTotalSignal[b] <- sum(insertionMatrix[b,])
} # end for (b in 1:numGenomeSites)
a <- 1
############################################################
## Load the temporary data
tempData <- list()
com <- paste0("tempData <- footprintData$", motifNames[a])
eval(parse(text = com))
##
librarySize <- tempData[["librarySize"]]
coverageSize <- tempData[["coverageSize"]]
libraryFactor <- tempData[["libraryFactor"]]
PWM <- tempData[["PWM"]]
genomeSites <- tempData[["genomeSites"]]
numGenomeSites <- tempData[["numGenomeSites"]]
motifWidth <- tempData[["motifWidth"]]
extendedSites <- tempData[["extendedSites"]]
insertionMatrix <- tempData[["insertionMatrix"]]
############################################################
## Calculate total signal for each site
siteTotalSignal <- c()
for (b in 1:numGenomeSites){
siteTotalSignal[b] <- sum(insertionMatrix[b,])
} # end for (b in 1:numGenomeSites)
uniqueTotalSiteSignals <- unique(siteTotalSignal)
## Remove NA values from uniqueTotalSignals
## (how do they get there???)
uniqueTotalSiteSignals <- uniqueTotalSiteSignals[!is.na(uniqueTotalSiteSignals)]
## Initiate a matrix to store the mean null signal in the null model and the input signal to null model
nullModels <- matrix(data = NA, ncol = 2, nrow = length(uniqueTotalSiteSignals))
colnames(nullModels) <- c("Total input signal", "Mean null motif signal")
## Calculate the null models
for (c in 1:length(uniqueTotalSiteSignals)){
nullVec <- generateNullFP(1000, uniqueTotalSiteSignals[c], (500 + motifWidth), motifWidth)
nullModels[c,1] <- uniqueTotalSiteSignals[c]
nullModels[c,2] <- mean(nullVec)
} # end for (c in 1:length(uniqueTotalSignals))
cat("Building functions", "\n")
generateNullFP <- function(iterations, inputSignal, analysisWidth, motifWidth){
# This script will be used to generate indiviudal null models at predicted motif binding sites across the genome when scanning for TF footprinting from ATAC-seq data. To generate these null models, the current model will need to:
#- Consider the total signal (number of insertions) at each specific ~200 bp locus
#- Use the actul underlying reference sequence of that ~200 bp stretch from the hg38 reference genome
#- Use published or experimentally derived models of Tn5 sequence specific insertion bias
#- For each locus, build a probablistic model of insertion site distributions based on the underlying sequence and Tn5 insertion bias
#- Generate the null model graph by weighted random residstribution of the total observed signal at that site
#- Importantly, the null model must be generated separately for the plus and minus strand, it can then be combined and compared to the combined signal from the reference observed signal at that sequence
# These null models can then be used for a site-by-site comparison of the null model against the observed data to accept or reject the null hypothesis
# iterations = number of iterations
# inputSignals = unique values for total signal
# analysisWidth = total bp in region of interest (flank + background + motif)
# motifWidth = motif width
##
#cat("Generating a null footprint model with the following parameters:", "\n")
#cat("Iterations:", iterations, "\n")
#cat("Input signal:", inputSignal, "\n")
#cat("Analysis window (bp):", analysisWidth, "\n")
#cat("Motif width (bp):", motifWidth, "\n")
# declare vector of size n to store average motif signal values
averages <- c()
# generate the null models and calculate motif averages
for (a in 1:iterations){
# declare the null vector
null <- c(1:(analysisWidth))
# randomly distribute the total signal
# size = the number of values to distribute
# prob = probability of each site
# length = length of the generated vector
null <- c(as.vector(rmultinom(1, size=inputSignal, prob=rep(1, length(null)))))
## Calculate the mean signal in motif region
motifStart <- ((analysisWidth - motifWidth)/2)
motifEnd <- (motifStart + motifWidth)
motifAvg <- (sum(null[motifStart:motifEnd])) / motifWidth
## Store the average values
averages[a] <- motifAvg
} # end for (a in 1:n)
return(averages)
} # end generateNullFP function
## Calculate the null models
for (c in 1:length(uniqueTotalSiteSignals)){
nullVec <- generateNullFP(1000, uniqueTotalSiteSignals[c], (500 + motifWidth), motifWidth)
nullModels[c,1] <- uniqueTotalSiteSignals[c]
nullModels[c,2] <- mean(nullVec)
} # end for (c in 1:length(uniqueTotalSignals))
## Perform a one-tailed t-test to generate a p-value for each observed motif site
cat("Performing one-tailed t-tests on binding site mean motif signal against null models", "\n")
ttest <- list() # list to store the results of the t-tests
pvalue <- c() # vector to store the p-values
tvalue <- c() # vector to store the t-value
## Perform t-test on all sites
for (d in 1:numGenomeSites){
## Retrieve the total signal for the current site
currentSignal <- c(siteTotalSignal[d])
## Retrieve the appropriate null model
currentNullModel <- nullModels[which(nullModels[,1] == currentSignal),2]
## Perform the t-test
ttest[[d]] <- t.test(insertionMatrix[d, 250:(250 + motifWidth)], mu = currentNullModel, alternative = "less", conf.level = 0.95)
pvalue[d] <- ttest[[d]][["p.value"]]
tvalue[d] <- ttest[[d]][["statistic"]][["t"]]
} # for (d in 1:numGenomeSites)
## Get the indices of the sites that are lower than p = 0.05
cat("Selecting p-value passing sites", "\n")
pvaluePassSiteIdx <- which(pvalue < 0.05)
## Perform bonferroni correction
cat("Performing bonferroni correction", "\n")
bfPvalueSiteIdx <- which(pvalue < (0.05 / numGenomeSites))
############################################################
## Bound genome sites subset
boundGenomeSites <- genomeSites[bfPvalueSiteIdx]
numBoundGenomeSites <- length(boundGenomeSites)
## Unbound genome sites subset
unboundGenomeSites <- genomeSites[-bfPvalueSiteIdx]
numUnboundGenomeSites <- length(unboundGenomeSites)
############################################################
############################################################
## Analyze the binding sites in peaks
cat("Processing binding sites in accessibility peaks", "\n")
peakOverlaps <- findOverlaps(genomeSites, grPeaks)
peakIndex <- unique(peakOverlaps@from)
peakSites <- genomeSites[peakIndex]
peakSites <- keepStandardChromosomes(peakSites, pruning.mode="coarse")
peakSites <- keepSeqlevels(peakSites, scope, pruning.mode="coarse")
peakSites <- trim(peakSites, use.names = TRUE)
numPeakSites <- length(peakSites)
cat("Found", numPeakSites, " binding sites in peak accessibility regions", "\n")
boundPeakOverlap <- findOverlaps(peakSites, boundGenomeSites)
boundPeakIndex <- unique(boundPeakOverlap@to)
boundPeakSites <- boundGenomeSites[boundPeakIndex]
numBoundPeakSites <- length(boundPeakSites)
##
unboundPeakOverlap <- findOverlaps(peakSites, unboundGenomeSites)
unboundPeakIndex <- unique(unboundPeakOverlap@to)
unboundPeakSites <- unboundGenomeSites[unboundPeakIndex]
numUnboundPeakSites <- length(unboundPeakSites)
## Calculate flanking accessibility and footprint depth data
cat("Calculating flanking accessibility and footprint depth data", "\n")
siteFootprintMetrics <- matrix(data = NA, ncol = 5, nrow = numGenomeSites)
##
colnames(siteFootprintMetrics) <- c("Background signal/bp", "Flank signal/bp", "Motif signal/bp",
"Flanking Accessibility", "Footprint Depth")
##
for (e in 1:numGenomeSites){
## Backgroup signal per bp
siteFootprintMetrics[e,1] <- ((sum(insertionMatrix[e, 1:50]) +
sum(insertionMatrix[e, (450 + motifWidth):(500 + motifWidth)])) /
100)
## Flank signal per bp
siteFootprintMetrics[e,2] <- ((sum(insertionMatrix[e, 200:250]) +
sum(insertionMatrix[e, (200 + motifWidth):(250 + motifWidth)])) /
100)
## Motif signal per bp
siteFootprintMetrics[e,3] <- (sum(insertionMatrix[e, (250:(250 + motifWidth))]) /
motifWidth)
## Flanking accessibility (Flanking signal / backgroun signal)
siteFootprintMetrics[e,4] <- (siteFootprintMetrics[e,2] / siteFootprintMetrics[e,1])
## Footprint depth (Motif signal / flank signal)
siteFootprintMetrics[e,5] <- (siteFootprintMetrics[e,3] / siteFootprintMetrics[e,2])
} # end (for e in 1:numGenomeSites)
View(siteFootprintMetrics)
View(siteFootprintMetrics)
############################################################
## Data transfer to storage object and save
cat("Transferring data to parsedFootprintData storage object", "\n")
tempData <- list()
##
tempData$librarySize <- librarySize
tempData$coverageSize <- coverageSize
tempData$libraryFactor <- libraryFactor
tempData$PWM <- PWM
tempData$genomeSites <- genomeSites
tempData$numGenomeSites <- numGenomeSites
tempData$motifWidth <- motifWidth
tempData$extendedSites <- extendedSites
tempData$insertionMatrix <- insertionMatrix
##
tempData$siteTotalSignal <- siteTotalSignal
tempData$uniqueTotalSiteSignals <- uniqueTotalSiteSignals
tempData$nullModels <- nullModels
tempData$ttest <- ttest
tempData$pvalue <- pvalue
tempData$tvalue <- tvalue
tempData$pvaluePassSiteIdx <- pvaluePassSiteIdx
tempData$bfPvalueSiteIdx <- bfPvalueSiteIdx
##
tempData$boundGenomeSites <- boundGenomeSites
tempData$numBoundGenomeSites <- numBoundGenomeSites
##
tempData$unboundGenomeSites <- unboundGenomeSites
tempData$numUnboundGenomeSites <- numUnboundGenomeSites
##
tempData$peakOverlaps <- peakOverlaps
tempData$peakIndex <- peakIndex
tempData$peakSites <- peakSites
tempData$numPeakSites <- numPeakSites
##
tempData$boundPeakOverlap <- boundPeakOverlap
tempData$boundPeakIndex <- boundPeakIndex
tempData$boundPeakSites <- boundPeakSites
tempData$numBoundPeakSites <- numBoundPeakSites
##
tempData$unboundPeakOverlap <- unboundPeakOverlap
tempData$unboundPeakIndex <- unboundPeakIndex
tempData$unboundPeakSites <- unboundPeakSites
tempData$numUnboundPeakSites <- numUnboundPeakSites
##
tempData$siteFootprintMetrics <- siteFootprintMetrics
## Transfer to the data storage object
com <- paste0("parsedFootprintData$motif", motifIdx, " <- tempData")
eval(parse(text = com))
View(parsedFootprintData)
View(parsedFootprintData)
load("C:/Users/Jordan/Desktop/LNCaP-WT-02.totalreads.Rdata")
cat("Found", sampleTotalReads, "total reads in current sample", "\n")
load("C:/Users/Jordan/Desktop/LNCaP-WT-02.MCR.parsedFootprintData.Rdata")
View(footprintData)
View(footprintData)
